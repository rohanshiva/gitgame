{"ast":null,"code":"import _objectSpread from\"/home/runner/work/gitgame/gitgame/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/home/runner/work/gitgame/gitgame/client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{useState,useEffect,useReducer}from\"react\";import{GameStateDispatchEventType,lobbyCode,RequestType,ResponseType}from\"../../../../Interface\";import gameReducer from\"../../reducers/GameReducer\";import config from\"../../../../config/Config\";function getWebSocketAddress(sessionId){return\"\".concat(config.wsUri,\"/\").concat(config.socket.uri.replace(\":sessionId\",sessionId));}function useGameConnection(sessionId,onAlert){var _useState=useState(null),_useState2=_slicedToArray(_useState,2),ws=_useState2[0],setWs=_useState2[1];var _useReducer=useReducer(gameReducer,{players:[],host:\"\",source_code:lobbyCode,comments:[],new_comments:[]}),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),disconnectionMessage=_useState4[0],setDisconnectionMessage=_useState4[1];useEffect(function(){var socket=new WebSocket(getWebSocketAddress(sessionId));socket.onmessage=function(_ref){var data=_ref.data;var payload=JSON.parse(data);if(payload.message_type===ResponseType.ALERT){onAlert(payload.alert);}else if(payload.message_type===ResponseType.BATCH){var batchPayload=payload;var alertPayload=batchPayload.messages.find(function(_ref2){var message_type=_ref2.message_type;return message_type===ResponseType.ALERT;});if(alertPayload){onAlert(alertPayload.alert);}}// AlertPayloads are ignored in the reducer\ndispatch(_objectSpread(_objectSpread({},payload),{},{event_type:GameStateDispatchEventType.WS_RESPONSE}));};socket.onclose=function(ev){if(ev.code>=4000){setDisconnectionMessage(ev.reason);}else{setDisconnectionMessage(\"Not sure what happened. Please refresh to re-connect!\");}};socket.onopen=function(){setDisconnectionMessage(null);};socket.onerror=function(ev){console.log(\"Ran into a WS error\",ev);};setWs(socket);return function(){if(socket&&socket.readyState!==WebSocket.CLOSED){console.log(\"Cleaning up connection\");socket.close();}};},[]);var sendMessage=function sendMessage(data){ws.send(JSON.stringify(data));};var pickSourceCode=function pickSourceCode(){sendMessage({message_type:RequestType.PICK_SOURCE_CODE});};var addComment=function addComment(comment){sendMessage(_objectSpread({message_type:RequestType.ADD_COMMENT},comment));};var ackNewComment=function ackNewComment(comment_id){dispatch({event_type:GameStateDispatchEventType.ACK_NEW_COMMENT,comment_id:comment_id});};var actions={pickSourceCode:pickSourceCode,addComment:addComment,ackNewComment:ackNewComment};var disconnection={isDisconnected:disconnectionMessage!=null,disconnectionMessage:disconnectionMessage};return{state:state,actions:actions,disconnection:disconnection};}export default useGameConnection;","map":{"version":3,"names":["useState","useEffect","useReducer","GameStateDispatchEventType","lobbyCode","RequestType","ResponseType","gameReducer","config","getWebSocketAddress","sessionId","concat","wsUri","socket","uri","replace","useGameConnection","onAlert","_useState","_useState2","_slicedToArray","ws","setWs","_useReducer","players","host","source_code","comments","new_comments","_useReducer2","state","dispatch","_useState3","_useState4","disconnectionMessage","setDisconnectionMessage","WebSocket","onmessage","_ref","data","payload","JSON","parse","message_type","ALERT","alert","BATCH","batchPayload","alertPayload","messages","find","_ref2","_objectSpread","event_type","WS_RESPONSE","onclose","ev","code","reason","onopen","onerror","console","log","readyState","CLOSED","close","sendMessage","send","stringify","pickSourceCode","PICK_SOURCE_CODE","addComment","comment","ADD_COMMENT","ackNewComment","comment_id","ACK_NEW_COMMENT","actions","disconnection","isDisconnected"],"sources":["/home/runner/work/gitgame/gitgame/client/src/components/game/hooks/gameConnection/UseGameConnection.tsx"],"sourcesContent":["import { useState, useEffect, useReducer } from \"react\";\nimport {\n  AddComment,\n  AlertPayload,\n  BatchPayload,\n  GameStateDispatchEvent,\n  GameStateDispatchEventType,\n  lobbyCode,\n  RequestType,\n  ResponsePayload,\n  ResponseType,\n} from \"../../../../Interface\";\nimport gameReducer from \"../../reducers/GameReducer\";\nimport config from \"../../../../config/Config\";\n\nfunction getWebSocketAddress(sessionId: string) {\n  return `${config.wsUri}/${config.socket.uri.replace(\n    \":sessionId\",\n    sessionId\n  )}`;\n}\n\nfunction useGameConnection(\n  sessionId: string,\n  onAlert: (alert: string) => void\n) {\n  const [ws, setWs] = useState<WebSocket>(null as unknown as WebSocket);\n  const [state, dispatch] = useReducer(gameReducer, {\n    players: [],\n    host: \"\",\n    source_code: lobbyCode,\n    comments: [],\n    new_comments: [],\n  });\n\n  const [disconnectionMessage, setDisconnectionMessage] = useState<\n    string | null\n  >(null);\n\n  useEffect(() => {\n    const socket = new WebSocket(getWebSocketAddress(sessionId));\n    socket.onmessage = ({ data }) => {\n      const payload: ResponsePayload = JSON.parse(data);\n      if (payload.message_type === ResponseType.ALERT) {\n        onAlert((payload as AlertPayload).alert);\n      } else if (payload.message_type === ResponseType.BATCH) {\n        const batchPayload = payload as BatchPayload;\n        const alertPayload = batchPayload.messages.find(\n          ({ message_type }) => message_type === ResponseType.ALERT\n        ) as AlertPayload;\n        if (alertPayload) {\n          onAlert(alertPayload.alert);\n        }\n      }\n\n      // AlertPayloads are ignored in the reducer\n      dispatch({\n        ...payload,\n        event_type: GameStateDispatchEventType.WS_RESPONSE,\n      });\n    };\n\n    socket.onclose = (ev: CloseEvent) => {\n      if (ev.code >= 4000) {\n        setDisconnectionMessage(ev.reason);\n      } else {\n        setDisconnectionMessage(\n          \"Not sure what happened. Please refresh to re-connect!\"\n        );\n      }\n    };\n\n    socket.onopen = () => {\n      setDisconnectionMessage(null);\n    };\n\n    socket.onerror = (ev) => {\n      console.log(\"Ran into a WS error\", ev);\n    };\n\n    setWs(socket);\n\n    return () => {\n      if (socket && socket.readyState !== WebSocket.CLOSED) {\n        console.log(\"Cleaning up connection\");\n        socket.close();\n      }\n    };\n  }, []);\n\n  const sendMessage = (data: any) => {\n    ws.send(JSON.stringify(data));\n  };\n\n  const pickSourceCode = () => {\n    sendMessage({ message_type: RequestType.PICK_SOURCE_CODE });\n  };\n\n  const addComment = (comment: AddComment) => {\n    sendMessage({ message_type: RequestType.ADD_COMMENT, ...comment });\n  };\n\n  const ackNewComment = (comment_id: string) => {\n    dispatch({\n      event_type: GameStateDispatchEventType.ACK_NEW_COMMENT,\n      comment_id: comment_id,\n    } as GameStateDispatchEvent);\n  };\n\n  const actions = {\n    pickSourceCode,\n    addComment,\n    ackNewComment,\n  };\n\n  const disconnection = {\n    isDisconnected: disconnectionMessage != null,\n    disconnectionMessage: disconnectionMessage,\n  };\n\n  return { state, actions, disconnection };\n}\n\nexport default useGameConnection;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}